# 群组搜索功能使用指南

本指南详细说明如何使用新增的群组搜索功能。

## 功能概述

用户可以直接在搜索群组中输入关键词，Bot 会自动返回搜索结果，无需输入命令。

### 新增功能

1. ✅ **群组自动搜索** - 在群组中输入任意文字即可搜索
2. ✅ **优化的结果显示** - 简洁美观，内容带超链接直达
3. ✅ **顶部广告位** - 可自定义广告内容
4. ✅ **类型分类按钮** - 快速筛选视频、图片、文档等
5. ✅ **翻页功能** - 浏览更多搜索结果

---

## 配置步骤

### 1. 更新环境变量

编辑 `.env` 文件，添加以下配置：

```env
# 频道配置
COLLECT_CHANNEL_ID=-1003241208550
STORAGE_CHANNEL_ID=-1003286651502
SEARCH_GROUP_ID=8068014765

# 搜索配置
SEARCH_AD_TEXT=💎 发现更多优质内容，关注我们的频道 @your_channel
SEARCH_AD_ENABLED=true
RESULTS_PER_PAGE=10
```

**配置说明：**

- `STORAGE_CHANNEL_ID`: 搜索数据存储频道 ID (`-1003286651502`)
- `SEARCH_GROUP_ID`: 你的搜索群组 ID (`8068014765`)
- `SEARCH_AD_TEXT`: 搜索结果顶部的广告文字（可自定义）
- `SEARCH_AD_ENABLED`: 是否启用广告（`true` 或 `false`）
- `RESULTS_PER_PAGE`: 每页显示结果数量（默认 10）

### 2. 将 Bot 加入搜索群组

1. 打开你的搜索群组
2. 点击"添加成员"
3. 搜索并添加你的 Bot
4. 确保 Bot 有读取消息的权限

### 3. 重启 Bot

```bash
# 如果使用 systemd
sudo systemctl restart telegram-search-bot

# 如果使用 nohup
pkill -f "python main.py"
nohup python main.py > bot.log 2>&1 &
```

---

## 使用方式

### 基础搜索

在搜索群组中直接输入关键词：

```
Python教程
```

Bot 会自动返回搜索结果：

```
📢 💎 发现更多优质内容，关注我们的频道 @your_channel
━━━━━━━━━━━━━━━━━━━━

🔍 搜索: "Python教程"
━━━━━━━━━━━━━━━━━━━━
📊 找到 15 条结果

1. 🎬 [Python零基础入门教程，适合初学者...](链接)
   📺 @tech_learning • 10-28

2. 📝 [Python爬虫实战项目完整教程...](链接)
   📺 @code_share • 10-25

3. 🎬 [Python数据分析入门到精通...](链接) ⏱️ 3600s
   📺 @data_science • 10-20

[📝 全部] [🎬 视频] [📸 图片] [📎 文档]
[◀️ 上一页] 1/2 [下一页 ▶️]
```

### 类型筛选

点击类型按钮即可筛选：

- **📝 全部** - 显示所有类型
- **🎬 视频** - 只显示视频（会显示时长）
- **📸 图片** - 只显示图片
- **📎 文档** - 只显示文档

### 翻页浏览

点击底部的翻页按钮：

- **◀️ 上一页** - 查看前一页
- **下一页 ▶️** - 查看下一页
- 中间显示当前页数

### 点击链接

搜索结果中的内容是超链接，点击即可直达原文。

---

## 搜索结果格式说明

### 结果结构

```
序号. emoji [内容标题](超链接) ⏱️ 时长(仅视频)
   📺 频道名 • 日期
```

### Emoji 说明

- 🎬 视频
- 📸 图片
- 📎 文档
- 📝 文本
- 🎵 音频

### 视频时长

如果是视频类型，会显示时长：
```
⏱️ 3600s  (表示视频时长 3600 秒)
```

---

## 自定义广告内容

### 修改广告文字

编辑 `.env` 文件：

```env
SEARCH_AD_TEXT=🎯 限时优惠！加入VIP频道享受更多福利 @vip_channel
```

**建议：**
- 保持在 1-2 句话以内
- 使用 emoji 增加吸引力
- 避免过长影响搜索结果查看

### 关闭广告

如果不想显示广告：

```env
SEARCH_AD_ENABLED=false
```

---

## 高级功能

### 调整每页结果数量

默认每页显示 10 条结果，可以调整：

```env
RESULTS_PER_PAGE=20
```

**建议值：**
- 手机端：5-10 条
- 桌面端：10-20 条

### 群组权限设置

**推荐设置：**
1. 允许所有成员发送消息
2. Bot 有读取消息权限
3. 可选：关闭群组历史记录（避免 Bot 处理旧消息）

### 多群组支持

目前只支持一个搜索群组。如果需要支持多个群组，需要修改代码：

```python
# config.py
SEARCH_GROUP_IDS = [8068014765, 8068014766, 8068014767]

# bot.py
self.app.add_handler(MessageHandler(
    filters.Chat(chat_id=config.SEARCH_GROUP_IDS) & filters.TEXT & ~filters.COMMAND,
    self.handle_search_group_message
))
```

---

## 注意事项

### 1. 性能考虑

- Bot 会对**每条消息**进行搜索
- 建议在专用搜索群组使用
- 避免在聊天频繁的群组启用

### 2. 搜索限制

- 最短关键词：2 个字符
- 过短的查询会被忽略

### 3. 结果链接

- 链接指向存储频道（`STORAGE_CHANNEL_ID`）
- 确保存储频道设置为公开或用户有访问权限
- 如果链接无法访问，检查频道 ID 是否正确

### 4. Markdown 格式

- 搜索结果使用 Telegram Markdown 格式
- 如果内容包含特殊字符可能导致格式错误
- Bot 会自动降级为纯文本格式

---

## 故障排查

### Bot 不响应群组消息

**检查步骤：**

1. 确认 Bot 在群组中
2. 确认 `SEARCH_GROUP_ID` 配置正确
3. 查看日志：
   ```bash
   tail -f bot.log | grep "群组搜索"
   ```

4. 检查 Bot 权限（需要读取消息权限）

### 搜索无结果

**可能原因：**

1. 数据库为空（未启用爬虫或未索引内容）
2. 关键词拼写错误
3. 内容不在已索引的频道中

**解决方法：**

```bash
# 检查数据库
sqlite3 data/channels.db "SELECT COUNT(*) FROM messages;"

# 如果为 0，说明没有索引数据
# 需要启用爬虫或手动添加测试数据
```

### 链接无法访问

**检查：**

1. 存储频道 ID 是否正确
2. 存储频道是否设置为公开或用户有权限
3. `storage_message_id` 是否存在

**测试链接：**

手动构建链接测试：
```
https://t.me/c/3286651502/消息ID
```

（去掉 ID 前面的 `-100`）

### 广告不显示

**检查：**

```env
SEARCH_AD_ENABLED=true  # 确保为 true
SEARCH_AD_TEXT=你的广告内容  # 确保有内容
```

重启 Bot 后生效。

---

## 效果展示

### 示例 1: 搜索视频

**输入：**
```
Python
```

**输出：**
```
📢 💎 发现更多优质内容，关注我们的频道 @tech_hub
━━━━━━━━━━━━━━━━━━━━

🔍 搜索: "Python"
━━━━━━━━━━━━━━━━━━━━
📊 找到 8 条结果

1. 🎬 [Python入门教程](链接) ⏱️ 1800s
   📺 @tech_learning • 11-01

2. 🎬 [Python爬虫实战](链接) ⏱️ 3600s
   📺 @code_share • 10-30

[📝 全部] [🎬 视频] [📸 图片] [📎 文档]
```

### 示例 2: 筛选视频类型

点击 **🎬 视频** 按钮后：

```
🔍 搜索: "Python"
📁 类型: 🎬 视频
━━━━━━━━━━━━━━━━━━━━
📊 找到 5 条结果

1. 🎬 [Python入门教程](链接) ⏱️ 1800s
2. 🎬 [Python爬虫实战](链接) ⏱️ 3600s
3. 🎬 [Python数据分析](链接) ⏱️ 2400s
```

### 示例 3: 无结果

**输入：**
```
asdfghjkl
```

**输出：**
```
🔍 搜索: "asdfghjkl"

😔 未找到相关内容

💡 提示:
• 尝试其他关键词
• 检查拼写是否正确
• 使用更通用的词语
```

---

## 最佳实践

### 1. 广告优化

**好的广告示例：**
```
💎 每日更新，关注 @daily_tech 获取最新资源
🔥 VIP会员专享福利，加入 @vip_club
⚡ 快速搜索，尽在 @search_pro
```

**不好的示例：**
```
我们这里有最全的资源库，包括各种类型的视频、文档、图片等等，欢迎大家加入我们的频道，获取更多优质内容...
（太长，影响查看）
```

### 2. 群组管理

- 设置群组描述说明如何使用
- Pin 一条使用说明消息
- 定期清理无关聊天（保持搜索纯净）

### 3. 内容优化

- 确保爬虫正常运行
- 定期检查索引内容质量
- 清理失效频道

---

## 更新日志

### v1.1.0 (2025-11-02)

- ✅ 新增群组搜索功能
- ✅ 优化搜索结果显示（带超链接）
- ✅ 添加顶部广告位
- ✅ 添加类型分类按钮
- ✅ 视频显示时长
- ✅ 改进翻页交互

---

## 技术支持

遇到问题？

1. 查看 [README.md](README.md)
2. 查看 [USAGE.md](USAGE.md)
3. 检查日志文件 `bot.log`
4. 联系管理员

---

**享受新的群组搜索功能！🎉**

